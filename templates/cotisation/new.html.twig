{# templates/cotisation/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Cr√©er une cotisation - Collab√âpargne{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/ccotisation.css') }}">
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/cotisation.js') }}" defer></script>
{% endblock %}

{% block body %}
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">Collab<span>√âpargne</span></div>
            <div class="user-info">
                <img src="{{ asset('image/profile.png') }}" alt="User" class="user-avatar">
                <div class="user-details">
                    <div class="user-name">{{ app.user.nom }} {{ app.user.prenom }}</div>
                    <div class="user-status">Membre actif</div>
                </div>
            </div>
        </div>
        
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item">
                <span class="menu-icon">üè†</span>
                <span><a href="{{ path('app_utilisateur') }}">Tableau de bord</a></span>
            </li>
            <li class="sidebar-menu-item active">
                <span class="menu-icon">‚ûï</span>
                <span><a href="{{ path('app_cotisation_new') }}">Cr√©er une cotisation</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üë•</span>
                <span><a href="{{ path('app_cotisation_index') }}">Mes cotisations</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üìä</span>
                <span><a href="#">Historique des contributions</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üìÖ</span>
                <span><a href="{{ path('app_echeance') }}">√âch√©ances</a></span>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="sidebar-menu-item">
                <span class="menu-icon">üö™</span>
                <span><a href="{{ path('app_logout') }}" class="btn btn-danger">D√©connexion</a></span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="sidebar-toggle" id="sidebar-toggle">‚ûï</button>
            <h1 class="page-title">Cr√©er une cotisation</h1>
            <div class="action-buttons">
                <a href="{{ path('app_utilisateur') }}" class="btn btn-outline">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                    Retour au tableau de bord
                </a>
            </div>
        </div>
        
        <!-- Mobile Action Buttons -->
        <div class="mobile-actions" style="display: none;">
            <a href="{{ path('app_utilisateur') }}" style="width: 100%; text-decoration: none;">
                <button class="btn btn-outline" style="width: 100%; margin-bottom: 1rem;">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                    Retour au tableau de bord
                </button>
            </a>
        </div>
        
        <!-- Form Container avec le formulaire Symfony -->
        <div class="form-container">
            {{ form_start(form, {'attr': {'class': 'create-form'}}) }}
                <div class="form-section">
                    <h2>Informations g√©n√©rales</h2>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form_label(form.titre, 'Titre de la cotisation', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.titre, {'attr': {'placeholder': 'Ex: Voyage au Maroc, Cadeau d\'anniversaire...'}}) }}
                            {{ form_errors(form.titre) }}
                        </div>
                        
                        <div class="form-group">
                            {{ form_label(form.typeCotisation, 'Type de cotisation', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.typeCotisation) }}
                            {{ form_errors(form.typeCotisation) }}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        {{ form_label(form.description, 'Description', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.description, {'attr': {'placeholder': 'D√©crivez l\'objectif de cette cotisation, comment les fonds seront utilis√©s...', 'rows': '4'}}) }}
                        {{ form_errors(form.description) }}
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form_label(form.montantObjectif, 'Montant objectif (FCFA)', {'label_attr': {'class': 'form-label'}}) }}
                            <div class="input-with-icon">
                                {{ form_widget(form.montantObjectif, {'attr': {'placeholder': 'Ex: 500000', 'min': '1'}}) }}
                                <span class="input-icon">FCFA</span>
                            </div>
                            <small class="form-helper">Montant total √† atteindre pour cette cotisation</small>
                            {{ form_errors(form.montantObjectif) }}
                        </div>
                        
                        <div class="form-group" id="montantEcheanceGroup">
                            {% if form.montantParEcheance is defined %}
                                {{ form_label(form.montantParEcheance, 'Montant par √©ch√©ance (FCFA)', {'label_attr': {'class': 'form-label'}}) }}
                                <div class="input-with-icon">
                                    {{ form_widget(form.montantParEcheance, {'attr': {'placeholder': 'Ex: 25000', 'min': '1'}}) }}
                                    <span class="input-icon">FCFA</span>
                                </div>
                                <small class="form-helper">Montant √† verser √† chaque p√©riode</small>
                                {{ form_errors(form.montantParEcheance) }}
                            {% endif %}
                        </div>
                        
                        <div class="form-group" id="montantMinimumGroup" style="{{ form.typeCotisation.vars.value != 'souscription' ? 'display: none;' : '' }}">
                            {{ form_label(form.montantMinimum, 'Montant minimum (FCFA)', {'label_attr': {'class': 'form-label'}}) }}
                            <div class="input-with-icon">
                                {{ form_widget(form.montantMinimum, {'attr': {'placeholder': 'Ex: 10000', 'min': '1'}}) }}
                                <span class="input-icon">FCFA</span>
                            </div>
                            <small class="form-helper">Montant minimum accept√© par contribution</small>
                            {{ form_errors(form.montantMinimum) }}
                        </div>
                    </div>
                </div>
                
                <div class="form-section" id="periodeSection">
                    <h2>P√©riode de cotisation</h2>
                    <div class="form-row date-row">
                        <div class="form-group">
                            {{ form_label(form.dateDebut, 'Date de d√©but', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.dateDebut, {'attr': {'style': 'width: 100%;
                                        padding: 1rem;
                                        border-radius: 8px;
                                        border: 1px solid #ddd;
                                        font-size: 1rem;
                                        transition: all 0.3s;
                                        background-color: #fff;'}}) }}
                            <small class="form-helper">Date √† laquelle la cotisation commence</small>
                            {{ form_errors(form.dateDebut) }}
                        </div>
                        
                        <div class="form-group date-fin-group">
                            {{ form_label(form.dateFin, 'Date de fin', {'label_attr': {'class': 'form-label'}}) }}
                            <div class="date-fin-container">
                                    {{ form_widget(form.dateFin, {'attr': {'style': 'width: 100%;
                                        padding: 1rem;
                                        border-radius: 8px;
                                        border: 1px solid #ddd;
                                        font-size: 1rem;
                                        transition: all 0.3s;
                                        background-color: #fff;'}}) }}
                                    
                                <div class="checkbox-container">
                                    <input type="checkbox" id="sansDateFin" name="sansDateFin">
                                    <label for="sansDateFin">Pas de date de fin</label>
                                </div>
                            </div>
                            <small class="form-helper">Date √† laquelle la cotisation se termine</small>
                            {{ form_errors(form.dateFin) }}
                        </div>
                    </div>
                    
                    <div class="form-row period-options" id="periodOptions" style="{{ form.typeCotisation.vars.value != 'periodique' ? 'display: none;' : '' }}">
                        {% if form.periodicite is defined %}
                        <div class="form-group">
                            {{ form_label(form.periodicite, 'P√©riodicit√©', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.periodicite) }}
                            <small class="form-helper">√Ä quelle fr√©quence les cotisations sont collect√©es</small>
                            {{ form_errors(form.periodicite) }}
                        </div>
                        {% endif %}
                        
                        {% if form.frequencePeriode is defined %}
                        <div class="form-group">
                            {{ form_label(form.frequencePeriode, 'Fr√©quence de p√©riode', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.frequencePeriode) }}
                            <small class="form-helper">Nombre de p√©riodes entre chaque collecte</small>
                            {{ form_errors(form.frequencePeriode) }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-info" id="frequenceExplication" style="{{ form.typeCotisation.vars.value != 'periodique' ? 'display: none;' : '' }}">
                        <div class="info-icon">‚ÑπÔ∏è</div>
                        <div class="info-text">Vous avez s√©lectionn√© une cotisation <strong><span class="frequency-type">mensuelle</span></strong> tous les <strong><span class="frequency-value">1</span> <span class="frequency-unit">mois</span></strong>.</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="location.href='{{ path('app_utilisateur') }}'">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">‚úì</span>
                        Cr√©er la cotisation
                    </button>
                </div>
            {{ form_end(form) }}
        </div>
    </div>
    
    <script>

        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les sections en fonction du type de cotisation
            toggleTypeCotisationSections();

            // Initialiser l'explication de fr√©quence
            updateFrequenceExplication();

            // Initialiser les champs de date
            const dateDebutInput = document.getElementById('{{ form.dateDebut.vars.id }}');
            if (!dateDebutInput.value) {
                const today = new Date();
                dateDebutInput.value = today.toISOString().substr(0, 10);
            }

            const dateFinInput = document.getElementById('{{ form.dateFin.vars.id }}');
            if (!dateFinInput.value) {
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 3);
                dateFinInput.value = nextMonth.toISOString().substr(0, 10);
            }

            // Handle "Pas de date de fin" checkbox
            const sansDateFinCheckbox = document.getElementById('sansDateFin');
            sansDateFinCheckbox.addEventListener('change', function() {
                if (sansDateFinCheckbox.checked) {
                    dateFinInput.disabled = true;
                    dateFinInput.value = '';
                } else {
                    dateFinInput.disabled = false;
                    const nextMonth = new Date();
                    nextMonth.setMonth(nextMonth.getMonth() + 3);
                    dateFinInput.value = nextMonth.toISOString().substr(0, 10);
                }
            });

            // Initialize "Pas de date de fin" checkbox state
            if (sansDateFinCheckbox.checked) {
                dateFinInput.disabled = true;
            }
        });

        // Fonction pour afficher/masquer les sections en fonction du type de cotisation
        function toggleTypeCotisationSections() {
            const type = document.getElementById('{{ form.typeCotisation.vars.id }}').value;

            const montantEcheanceGroup = document.getElementById('montantEcheanceGroup');
            const montantMinimumGroup = document.getElementById('montantMinimumGroup');
            const periodOptions = document.getElementById('periodOptions');
            const frequenceExplication = document.getElementById('frequenceExplication');
            const periodeSection = document.getElementById('periodeSection');

            if (type === 'periodique') {
                montantEcheanceGroup.style.display = 'block';
                montantMinimumGroup.style.display = 'none';
                periodOptions.style.display = 'flex';
                frequenceExplication.style.display = 'flex';
                periodeSection.classList.remove('souscription-mode');
            } else {
                montantEcheanceGroup.style.display = 'none';
                montantMinimumGroup.style.display = 'block';
                periodOptions.style.display = 'none';
                frequenceExplication.style.display = 'none';
                periodeSection.classList.add('souscription-mode');
            }

            toggleRequiredFields();
        }

        // Fonction pour mettre √† jour les champs requis
        function toggleRequiredFields() {
            const type = document.getElementById('{{ form.typeCotisation.vars.id }}').value;

            {% if form.montantParEcheance is defined %}
            const montantEcheanceInput = document.getElementById('{{ form.montantParEcheance.vars.id }}');
            {% endif %}
            const montantMinimumInput = document.getElementById('{{ form.montantMinimum.vars.id }}');

            if (type === 'periodique') {
                {% if form.montantParEcheance is defined %}
                montantEcheanceInput.required = true;
                {% endif %}
                montantMinimumInput.required = false;
            } else {
                {% if form.montantParEcheance is defined %}
                montantEcheanceInput.required = false;
                {% endif %}
                montantMinimumInput.required = true;
            }
        }

        // Fonction pour mettre √† jour l'explication de fr√©quence
        function updateFrequenceExplication() {
            {% if form.periodicite is defined and form.frequencePeriode is defined %}
            const periodicite = document.getElementById('{{ form.periodicite.vars.id }}');
            const frequence = document.getElementById('{{ form.frequencePeriode.vars.id }}');

            if (periodicite && frequence) {
                const periodiciteValue = periodicite.value;
                const frequenceValue = frequence.value;

            let typeText, unitText;

            switch (periodiciteValue) {
                case 'journalier':
                    typeText = 'journali√®re';
                    unitText = frequenceValue > 1 ? 'jours' : 'jour';
                    break;
                case 'hebdomadaire':
                    typeText = 'hebdomadaire';
                    unitText = frequenceValue > 1 ? 'semaines' : 'semaine';
                    break;
                case 'mensuel':
                    typeText = 'mensuelle';
                    unitText = frequenceValue > 1 ? 'mois' : 'mois';
                    break;
                default:
                    typeText = 'personnalis√©e';
                    unitText = 'p√©riode(s)';
            }

            document.querySelector('.frequency-type').textContent = typeText;
            document.querySelector('.frequency-value').textContent = frequenceValue;
            document.querySelector('.frequency-unit').textContent = unitText;
}
            {% endif %}
        }

        // Ajouter des √©couteurs d'√©v√©nements
        document.getElementById('{{ form.typeCotisation.vars.id }}').addEventListener('change', function() {
toggleTypeCotisationSections();
            updateFrequenceExplication();
        });

        {% if form.periodicite is defined and form.frequencePeriode is defined %}
        document.getElementById('{{ form.periodicite.vars.id }}').addEventListener('change', updateFrequenceExplication);
        document.getElementById('{{ form.frequencePeriode.vars.id }}').addEventListener('change', updateFrequenceExplication);
        {% endif %}
    </script>
{% endblock %}