{% extends 'base.html.twig' %}

{% block title %}Cr√©er une cotisation - Collab√âpargne{% endblock %}

{% block body %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/cotisation.css') }}">
{% endblock %}
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">Collab<span>√âpargne</span></div>
            <div class="user-info">
                <img src="{{ asset('image/profile.png') }}" alt="User" class="user-avatar">
                <div class="user-details">
                    <div class="user-name">{{ app.user.nom }} {{ app.user.prenom }}</div>
                    <div class="user-status">Membre actif</div>
                </div>
            </div>
        </div>
        
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item">
                <span class="menu-icon">üè†</span>
                <span><a href="{{ path('app_utilisateur') }}">Tableau de bord</a></span>
            </li>
            <li class="sidebar-menu-item active">
                <span class="menu-icon">‚ûï</span>
                <span><a href="{{ path('app_creation_cotisation') }}" style="color: #fff; text-decoration: none;">Cr√©er une cotisation</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üë•</span>
                <span><a href="#" style="color: #fff; text-decoration: none;">Mes cotisations</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üí∞</span>
                <span><a href="#" style="color: #fff; text-decoration: none;">Mes √©pargnes</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üìä</span>
                <span><a href="#" style="color: #fff; text-decoration: none;">Historique des contributions</a></span>
            </li>
            <li class="sidebar-menu-item">
                <span class="menu-icon">üìÖ</span>
                <span><a href="{{ path('app_echeance') }}" style="color: #fff; text-decoration: none;">√âch√©ances</a></span>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="sidebar-menu-item">
                <span class="menu-icon">üö™</span>
                <span><a href="{{ path('app_logout') }}" class="btn btn-danger">D√©connexion</a></span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="sidebar-toggle" id="sidebar-toggle">‚ò∞</button>
            <h1 class="page-title">Cr√©er une cotisation</h1>
            <div class="action-buttons">
                <a href="{{ path('app_utilisateur') }}" class="btn btn-outline">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                    Retour au tableau de bord
                </a>
            </div>
        </div>
        
        <!-- Mobile Action Buttons -->
        <div class="mobile-actions" style="display: none;">
            <a href="{{ path('app_utilisateur') }}" style="width: 100%; text-decoration: none;">
                <button class="btn btn-outline" style="width: 100%; margin-bottom: 1rem;">
                    <span class="btn-icon">‚Ü©Ô∏è</span>
                    Retour au tableau de bord
                </button>
            </a>
        </div>
        
        <!-- Form Container -->
        <div class="form-container">
            <form method="post" action="{{ path('app_creation_cotisation') }}" class="create-form">
                <div class="form-section">
                    <h2>Informations g√©n√©rales</h2>
                    <div class="form-group">
                        <label for="titre">Titre de la cotisation</label>
                        <input type="text" id="titre" name="titre" required placeholder="Ex: Voyage au Maroc, Cadeau d'anniversaire...">
                    </div>
                    
                    <div class="form-group">
                        <label for="initiateur">Nom de l'initiateur du projet</label>
                        <input type="text" id="initiateur" name="initiateur" required placeholder="Ex: Jean Dupont">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="montantObjectif">Montant objectif (FCFA)</label>
                            <input type="number" id="montantObjectif" name="montantObjectif" min="1" required placeholder="Ex: 500000">
                        </div>
                        
                        <div class="form-group">
                            <label for="montantEcheance">Montant par √©ch√©ance (FCFA)</label>
                            <input type="number" id="montantEcheance" name="montantEcheance" min="1" required placeholder="Ex: 25000">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>P√©riode de cotisation</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dateDebut">Date de d√©but</label>
                            <input type="date" id="dateDebut" name="dateDebut" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="dateFin">Date de fin (optionnelle)</label>
                            <input type="date" id="dateFin" name="dateFin">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="periodicite">P√©riodicit√©</label>
                        <select id="periodicite" name="periodicite" required>
                            <option value="hebdomadaire">Hebdomadaire</option>
                            <option value="mensuelle" selected>Mensuelle</option>
                            <option value="trimestrielle">Trimestrielle</option>
                            <option value="personnalisee">Personnalis√©e</option>
                        </select>
                    </div>
                    
                    <div class="form-group custom-periodicity" style="display: none;">
                        <label for="joursPeriodicite">Nombre de jours entre chaque √©ch√©ance</label>
                        <input type="number" id="joursPeriodicite" name="joursPeriodicite" min="1" placeholder="Ex: 15">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Membres</h2>
                    <div class="form-group">
                        <label for="searchMember">Rechercher un membre</label>
                        <div class="search-input-container">
                            <input type="text" id="searchMember" placeholder="Nom, pr√©nom ou num√©ro de t√©l√©phone">
                            <button type="button" class="search-btn">üîç</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Membres s√©lectionn√©s</label>
                        <div class="tag-input-container">
                            <div class="tags-container">
                                <!-- Les tags seront ajout√©s ici dynamiquement -->
                            </div>
                            <input type="hidden" id="membres" name="membres" value="">
                        </div>
                    </div>
                    
                    <div class="members-list-container">
                        <h3>Membres disponibles</h3>
                        <div class="members-list">
                            {% if utilisateurs is defined and utilisateurs|length > 0 %}
                                {% for utilisateur in utilisateurs %}
                                    <div class="member-item" data-id="{{ utilisateur.id }}" data-nom="{{ utilisateur.nom }}" data-prenom="{{ utilisateur.prenom }}" data-telephone="{{ utilisateur.telephone }}">
                                        <div class="member-info">
                                            <div class="member-name">{{ utilisateur.nom }} {{ utilisateur.prenom }}</div>
                                            <div class="member-phone">{{ utilisateur.telephone }}</div>
                                        </div>
                                        <button type="button" class="add-member-btn">+</button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-members">
                                    <p>Aucun autre membre n'est disponible</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Options suppl√©mentaires</h2>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="rappelAuto" name="rappelAuto" checked>
                        <label for="rappelAuto">Activer les rappels automatiques</label>
                    </div>
                    
                    <div class="form-group checkbox">
                        <input type="checkbox" id="cotisationPublique" name="cotisationPublique">
                        <label for="cotisationPublique">Rendre cette cotisation publique</label>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description (optionnelle)</label>
                        <textarea id="description" name="description" rows="4" placeholder="D√©crivez l'objectif de cette cotisation..."></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="location.href='{{ path('app_utilisateur') }}'">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">‚úì</span>
                        Cr√©er la cotisation
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Toggle sidebar on mobile
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });
        
        // Show/hide custom periodicity based on select
        document.getElementById('periodicite').addEventListener('change', function() {
            const customPeriodicity = document.querySelector('.custom-periodicity');
            if (this.value === 'personnalisee') {
                customPeriodicity.style.display = 'block';
            } else {
                customPeriodicity.style.display = 'none';
            }
        });
        
        // Mobile detection for responsive UI
        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.querySelector('.mobile-actions').style.display = 'block';
                document.querySelector('.action-buttons').style.display = 'none';
            } else {
                document.querySelector('.mobile-actions').style.display = 'none';
                document.querySelector('.action-buttons').style.display = 'flex';
            }
        }
        
        // Check on load and resize
        window.addEventListener('load', checkMobile);
        window.addEventListener('resize', checkMobile);
        
        // Handle members selection
        const membresInput = document.getElementById('membres');
        const tagsContainer = document.querySelector('.tags-container');
        const searchInput = document.getElementById('searchMember');
        const membersList = document.querySelector('.members-list');
        const memberItems = document.querySelectorAll('.member-item');
        
        let selectedMembers = [];
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            memberItems.forEach(item => {
                const nom = item.dataset.nom.toLowerCase();
                const prenom = item.dataset.prenom.toLowerCase();
                const telephone = item.dataset.telephone.toLowerCase();
                
                if (nom.includes(searchTerm) || prenom.includes(searchTerm) || telephone.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Add member to selected list
        document.querySelectorAll('.add-member-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const memberItem = this.closest('.member-item');
                const memberId = memberItem.dataset.id;
                const memberName = `${memberItem.dataset.prenom} ${memberItem.dataset.nom}`;
                const memberPhone = memberItem.dataset.telephone;
                
                if (!selectedMembers.some(member => member.id === memberId)) {
                    selectedMembers.push({
                        id: memberId,
                        name: memberName,
                        phone: memberPhone
                    });
                    
                    updateSelectedMembers();
                    updateMembresInput();
                    
                    // Hide from list or disable button
                    this.disabled = true;
                    this.textContent = '‚úì';
                }
            });
        });
        
        function updateSelectedMembers() {
            tagsContainer.innerHTML = '';
            
            selectedMembers.forEach(member => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    <span>${member.name} (${member.phone})</span>
                    <span class="tag-remove" data-id="${member.id}">√ó</span>
                `;
                tagsContainer.appendChild(tag);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idToRemove = this.getAttribute('data-id');
                    
                    // Remove from selected members
                    selectedMembers = selectedMembers.filter(member => member.id !== idToRemove);
                    
                    // Update UI
                    updateSelectedMembers();
                    updateMembresInput();
                    
                    // Re-enable button in list
                    const memberBtn = document.querySelector(`.member-item[data-id="${idToRemove}"] .add-member-btn`);
                    if (memberBtn) {
                        memberBtn.disabled = false;
                        memberBtn.textContent = '+';
                    }
                });
            });
        }
        
        function updateMembresInput() {
            // Just store member IDs for form submission
            const memberIds = selectedMembers.map(member => member.id);
            membresInput.value = JSON.stringify(memberIds);
        }
    </script>
{% endblock %}